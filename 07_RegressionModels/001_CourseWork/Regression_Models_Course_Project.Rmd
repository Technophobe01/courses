---
title: "Regression Models Course Project"
author: "Technophobe01"
date: '`r Sys.Date()`'
output:
  html_document: default
  pdf_document:
    fig_caption: yes
    number_sections: yes
header-includes: \usepackage[compact]{titlesec}
---

```{r setOptions, echo=FALSE, message=FALSE, results='hide'}
require(knitr)
opts_chunk$set(fig.width=6, fig.height=3, 
               fig.path='Figs/',
               cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, results='show')
require(knitcitations)
cleanbib()
```

```{r Setup, results='hide'}
setwd("~/dev/cousera/courses/07_RegressionModels/001_CourseWork")

# Load the mtcars dataset...
data("mtcars")

# Load the required R packages...
#
requiredPackages <- c("ggplot2",   # Used to plot graphics 
                      "ggthemes",  # Extra themes, scales and geoms for ggplot (Very cool!)
                      "xtable",
                      "dplyr",
                      "compare",
                      "Hmisc",
                      "tables",
                      "pander",
                      "gplots",
                      "HH",
                      "Rmisc")

ipak <- function(pkg){
        new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
        if (length(new.pkg))
                install.packages(new.pkg, dependencies = TRUE)
        sapply(pkg, require, character.only = TRUE)
}

ipak(requiredPackages)
```

# Executive Summary - 1974 Motor Trend Data in Review 

This report was requested to enable a review of the 1974 magazine data on past car mpg performance and changes in vehicle efficiency. It address to core quesitons:

1. Is an automatic or manual transmission better for MPG?
1. Quantify the MPG difference between automatic and manual transmissions.  

Based upon our analysis we conclude that in 1974: 

1. _**Manual tranmisssions were better for MPG**_.
1. Transmission, weight and quarter mile time significantly influenced mpg effienciency.
1. Manual transmissions were on average _**7.24 miles per gallon**_ more efficient that automatics.
1. For the same weight and quarter mile time, manual transmission cars were between **1.41** and **2.23** miles per gallon more efficient than an automatic transmission (Depending on whether we account for transmission and weight interaction in the linear model).

**Conclusion:** In 1974, cars that were lighter in weight with a manual transmission and cars that were heavier in weight with an automatic transmission had higher MPG values. See: Appendix A, Figure 2.

Note: The report source code is available via **[GitHub][2]** for deeper review. 

## Data Set Description

The Motor Trend magazine data was extracted in 1974, it coverered gasoline mileage in miles per gallon (MPG), and ten aspects of vehicle design and performance for 32 vehicles (1973-74 models), the sample includes 32 vehicles and has a bias to exotic, non-US., automobiles: it includes seven Mercedes, a Porsche, a Ferrari, a Maserati and offers us us an amazing view of vehicle effiency and performance from 1974.

## Basic exploratory data analyses 

Our initial goal was to test the hypothesis that cars in 1974 with an automatic transmission used more fuel than cars with a manual transmission. Whether cars have an automatic or manual transmission is found in the `am` (**Auto/Manual**) column of the `mtcars` dataset.
 
###  Is an automatic or manual transmission better for MPG? **Answer:\(\color{red}"Manual"\)**

The box plot (Appendix A, Figure 1.) provides a simple yet clear indication that automatic cars from the 1974 data set had lower mpg effienciency (**Automatic Transmission Median: 17.15 mpg**) than the manual cars reviewed (**Manual Transmission Median: 24.39 mpg**). Based on figure 1 we appear to have a clear hypothesis that automatic cars had a lower miles per gallon, and therefore a lower fuel efficiency, than manual cars did. i.e (24.39mpg - 17.15mpg creates a 7.24mpg manual transmission advantage. _The median is depicted as a thick line in figure 1, the edges of the box show the 25th and 75th quantiles of the data respectively_.   

Did lower automatic transmission mpg effienency in 1974 data happened by random chance? To try to confirm, we performed a **t.test()** - `t.test(mpg ~ am, data=mtcars)`. Our goal being to determine if MPG results relied on having an automatic or manual transmission. In essence, we wanted to try to refute that random chance created the inference depicted in figure 1.

```{r T_Test_MPG_MANUAL-Automatic, results='asis'}

# Perform suplement t.test 
t1 <- t.test(mpg ~ am, data=mtcars)

# Format and extract t-test confidence value
confValue <- paste0( attr(t1$conf.int, "conf.level" )*100,"%")

displayTable <- data.frame("P Value"=c(t1$p.value),
                           "Confidence"= c(confValue),
                           "Lower Bound"=c(t1$conf.int[1]),
                           "Upper Bound"=c(t1$conf.int[2]),
                           row.names=c("MPG ~ Transmission"))

# displayTable <- cbind(displayTable,"Alternate hypothesis"=c(t1$alternative))

pandoc.table(displayTable, 
             style = "multiline", 
             split.tables = 100)

```

The t-test **p-value** result of **`r t1$p.value`** in combination with a confidence value of **`r attr(t1$conf.int, "conf.level" )*100`%**, indicate that we can be confident that the probability of chance is low.  We conclude that automatic transmissions **did** have lower **MPG** in 1974 than manuals, what we were unable to determine from this initial testing is what exactly was causing the correlation. We checked to see if automobile weight in 1974 _**correlated**_ with _**MPG**_ efficiency. **Appendix A, Figure 2** shows that in 1974 automobile weight did correlate with MPG for both manual and automatic cars. Here we used a linear model to depict the manual and automatic trend lines.

### Answer: Quantify the MPG difference between automatic and manual transmissions. 

**Appendix A, Figure 3** shows our final exploratory chart which indicates visually that weight is a key driving factor. However, the predictors (Weight, Cylinder Size, and Displacement) could potentially be confounded. To determine which predictors were significant, and to select the preferred model to use, we performed an Akaike information criterion (AIC) model selection _**(Ref: The R Book, Chapter 9.17)**_ against the baseline linear model, the smaller the AIC, the better the fit.

```{r Regression_Analysis, echo=TRUE, results='hide'}
baseline <- lm(mpg ~ ., data=mtcars)
prefferedModel <- step(baseline, k=log(nrow(mtcars)))
```

we reviewed the `prefferedModel` results and picked **weight**, **quarter mile** and **transmission** as the predictors of most value based on the lowest **AIC of 67.17**. Our final check was to see if the predictors interact. We checked this with `aov` and noted that `wt` and `am` do appear to interact **(Sum Sq 52.0)**, hence we specified to `lm()` that weight and transmission interact `wt:am`

```{r SelectModel, echo=TRUE, results='hide'}

selectedModel <- aov(mpg ~ wt*qsec*am, data=mtcars)
summary(selectedModel)
finalModel <- lm(mpg ~ wt + qsec + am + wt:am, data=mtcars)
summary(finalModel)$coef

```

Thus, the result shows that when `wt` **(weight/1000lbs)** and `qsec` **(1/4 mile time)** are fixed we can calculate the manual transmission advantage over an equivalent automatic transmission. Without interaction we see a **1.41mpg** advantage, if we remove interaction of weight and transmission we see a **2.23mpg** advantage.

```{r prediction, echo=TRUE, results='hide'}

newcar = data.frame(wt=2.5, qsec=16.5, am=1)
predict(finalModel, newcar)

```

That is, a manual transmission car that weighs 2500 lbs has, with a qsec of 16.5 has a predicted mpg of **22.9mpg**. We can also use the model to predict the mpg of all the vehicles in mtcars. 

```{r prediction2, echo=TRUE, results='hide'}

predict(finalModel)

```
## Residual Analysis / Diagnostics

To wrap up, we ran a model fit, we can verify the following underlying assumptions:

1. The Residuals vs. Fitted plot shows no consistent pattern, in support of accuracy of the independence.
1. The Normal Q-Q plot indicates that the residuals are normally distributed to the line.
1. The Scale-Location plot confirms the constant variance assumption, points are randomly distributed.
1. The Residuals vs. Leverage implies no outliers are present, as all values fall well within the 0.5 bands.
1. We conclude that we do not have influential observations based on the `dfbetas` result of `0`. `dfbetas` is a measure of influence of the observations on the regression coefficients. The thumb rule for the `dfbetas is that if their absolute value exceeds 1, the observations have significant influence on the covariates.

```{r FinalCheck, echo=FALSE, results='hide'}
sum((abs(dfbetas(finalModel)))>1)
```

\pagebreak

# Appendix A

```{r Exploratory_Plot, results='hide', fig.cap="Exploratory BoxPlot"}

mtcars$am <- as.factor(mtcars$am)
levels(mtcars$am) <- c("Automatic", "Manual")


gp <- ggplot(mtcars, aes(x=factor(am), y=mpg, color=am))
gp <- gp + geom_boxplot()

# Here we use a function to correctly position the Boxplot mean labels
mean.n <- function(x){
  return(c(y = median(x)*1.04, label = round(mean(x),2))) 
  # experiment with the multiplier to find the perfect position
}

gp <- gp + stat_summary(fun.data = mean.n, geom = "text", size=2, lineheight=.8, fun.y = mean, colour = "Black")

gp <- gp + theme_wsj() 
gp <- gp + xlab("Transmission (Auto / Manual)")
gp <- gp + ylab("Miles per Gallon")
# Legend label, use darker colors
gp <- gp + ggtitle("Miles per Gallon by Transmission Type")
gp <- gp + expand_limits(y=0)                        # Expand y range
gp <- gp + scale_y_continuous(breaks=0:20*5)         # Set tick every 5
gp <- gp + theme(legend.position=c(.5, .1), 
                  plot.title = element_text(size=8, 
                                            lineheight=.8, face="bold"))
gp <- gp + theme(legend.title = element_text(size = 8, face = 'bold'))
gp <- gp + theme(legend.text = element_text(size = 8, face = 'bold'))
gp <- gp + theme(axis.text = element_text(size = 8, face = 'bold'))
# gp <- gp + theme(Stat.Median = element_text(size = 8, face = 'bold'))
print(gp)
```



```{r Exploratory_Linear_Plot, fig.cap="Exploratory Linear Plot"}

gp <- ggplot(mtcars, aes(x=wt*1000, y=mpg, col=am))
gp <- gp + geom_point()
gp <- gp + geom_smooth(method="lm")
gp <- gp + theme_wsj() 
gp <- gp + expand_limits(y=0)                        # Expand y range
gp <- gp + scale_y_continuous(breaks=0:20*5)         # Set tick every 5
gp <- gp + xlab("Automobile Weight per 1000lbs")
gp <- gp + ylab("Miles per Gallon")
# Legend label, use darker colors
gp <- gp + ggtitle("Miles per Gallon by Automobile Weight")
gp <- gp + theme(legend.position=c(.5, .1), 
                  plot.title = element_text(size=8, 
                                            lineheight=.8, face="bold"))
gp <- gp + theme(legend.title = element_text(size = 8, face = 'bold'))
gp <- gp + theme(legend.text = element_text(size = 8, face = 'bold'))
gp <- gp + theme(axis.text = element_text(size = 8, face = 'bold'))
print(gp)
```

\pagebreak

```{r Exploratory_Multiple_Linear_Regression_Plot, fig.height=4, fig.cap="Exploratory Multiple Linear Regression Plot", echo=FALSE, warning=FALSE, message=FALSE, results='show'}

gp <- ggplot(mtcars, aes(x=wt*1000, y=mpg, col=cyl, size=disp))
gp <- gp + geom_point()
gp <- gp + theme_wsj() 
gp <- gp + expand_limits(y=0)                        # Expand y range
gp <- gp + xlab("Automobile Weight per 1000lbs")
gp <- gp + ylab("Miles per Gallon")
# Legend label, use darker colors
gp <- gp + ggtitle("MPG by Automobile Weight, Cyclinder Size and Displacement")
gp <- gp + theme(legend.position=c(.3, .2), 
                  plot.title = element_text(size=8, 
                                            lineheight=.8, face="bold"))
gp <- gp + theme(legend.title = element_text(size = 8, face = 'bold'))
gp <- gp + theme(legend.text = element_text(size = 8, face = 'bold'))
gp <- gp + theme(axis.text = element_text(size = 8, face = 'bold'))

print(gp)

```


\pagebreak


```{r Exploratory_Fit_plot, fig.width=6, fig.height=6, fig.cap="Exploratory Model Fit Plots"}

bestfit <- lm(mpg ~ wt + qsec + am + wt:am, data=mtcars)
par(mfrow = c(2,2))
plot(bestfit)

```   

# **References**

- *The R Book*

    - By: Michael J. Crawley, Publisher: John Wiley & Sons Pub. Date: December 26, 2012, eISBN: 978-1-118-44896-0

- *R in Action*

    - By: Robert Kabacoff Publisher: Manning Publications Pub. Date: August 24, 2011, ISBN-10: 1-935182-39-0

- *Mathematical Statistics with Resampling and R*     
    
    - By: Laura Chihara; Tim Hesterberg Publisher: John Wiley & Sons Pub. Date: September 6, 2011 Print ISBN: 978-1-11-02985-5

- *Think Stats, 2nd Edition* 
    
    - By: Allen B. Downey Publisher: O'Reilly Media, Inc. Pub. Date: October 28, 2014 Print ISBN-13: 978-1-4919-0733-7

[0]: https://class.coursera.org/regmods-014
[1]: http://stat.ethz.ch/R-manual/R-devel/library/datasets/html/mtcars.html
[2]: https://github.com/Technophobe01/courses/tree/master/07_RegressionModels/001_CourseWork
[3]: http://www.jstor.org/discover/10.2307/2530428?uid=3739960&uid=2129&uid=2&uid=70&uid=4&uid=3739256&sid=21106429238751
[4]: http://www.washingtonpost.com/blogs/wonkblog/wp/2013/12/13/cars-in-the-u-s-are-more-fuel-efficient-than-ever-heres-how-it-happened/
[5]: https://www.fueleconomy.gov/feg/atv.shtml

